PKG_NAME = linuxtv
PKG_VERS = ea2766f
PKG_EXT = tar.gz
PKG_DOWNLOAD_METHOD = git
PKG_GIT_HASH = ea2766f182b3a4e03543be2ded0845fca4d4fa80
PKG_DIST_SITE = http://git.linuxtv.org/cgit.cgi/media_build.git
PKG_DIST_FILE = $(PKG_NAME)-git$(PKG_GIT_HASH).$(PKG_EXT)
PKG_DIR = $(PKG_NAME)-git$(PKG_GIT_HASH)
MOD_DIR = /lib/modules

DEPENDS =

REQ_KERNEL = 1
UNSUPPORTED_KERNEL = 3.10.102+
UNSUPPORTED_KERNEL += 3.2.40+

HOMEPAGE = https://linuxtv.org/
COMMENT  = The LinuxTV community develops and maintains the Linux Kernel Media Subsystems and several userspace libraries and applications.
LICENSE  = GPLv2

#CONFIGURE_ARGS = 

FIRMWARE_URL = http://www.linuxtv.org/downloads/firmware/
FIRMWARE_PKG = dvb-firmwares.tar.bz2

CONFIGURE_TARGET = linuxtv_configure
COMPILE_TARGET = linuxtv_compile
INSTALL_TARGET = linuxtv_install

# Disable all PCI adapters
# (will probably require more work and an external conf file)
BLACKLIST = CONFIG_DVB_B2C2_FLEXCOP_PCI
BLACKLIST += CONFIG_DVB_B2C2_FLEXCOP_PCI_DEBUG
BLACKLIST += CONFIG_DVB_BT8XX
BLACKLIST += CONFIG_DVB_BUDGET
BLACKLIST += CONFIG_DVB_BUDGET_AV
BLACKLIST += CONFIG_DVB_BUDGET_CI
BLACKLIST += CONFIG_DVB_BUDGET_CORE
BLACKLIST += CONFIG_DVB_BUDGET_PATCH
BLACKLIST += CONFIG_DVB_DDBRIDGE
BLACKLIST += CONFIG_DVB_DDBRIDGE_MSIENABLE
BLACKLIST += CONFIG_DVB_DM1105
BLACKLIST += CONFIG_DVB_HOPPER
BLACKLIST += CONFIG_DVB_MANTIS
BLACKLIST += CONFIG_MANTIS_CORE
BLACKLIST += CONFIG_DVB_NETUP_UNIDVB
BLACKLIST += CONFIG_DVB_NGENE
BLACKLIST += CONFIG_DVB_PLUTO2
BLACKLIST += CONFIG_DVB_PT1
BLACKLIST += CONFIG_DVB_PT3
BLACKLIST += CONFIG_DVB_SMIPCIE
BLACKLIST += CONFIG_MEDIA_ALTERA_CI
BLACKLIST += CONFIG_TTPCI_EEPROM
BLACKLIST += CONFIG_VIDEO_MXB
BLACKLIST += CONFIG_VIDEO_BT819
BLACKLIST += CONFIG_VIDEO_BT848
BLACKLIST += CONFIG_VIDEO_BT856
BLACKLIST += CONFIG_VIDEO_BT866
BLACKLIST += CONFIG_VIDEO_CX23885
BLACKLIST += CONFIG_VIDEO_CX88
BLACKLIST += CONFIG_VIDEO_CX88_ALSA
BLACKLIST += CONFIG_VIDEO_CX88_BLACKBIRD
BLACKLIST += CONFIG_VIDEO_CX88_DVB
BLACKLIST += CONFIG_VIDEO_CX88_ENABLE_VP3054
BLACKLIST += CONFIG_VIDEO_CX88_MPEG
BLACKLIST += CONFIG_VIDEO_CX88_VP3054
BLACKLIST += CONFIG_VIDEO_DT3155
BLACKLIST += CONFIG_VIDEO_FB_IVTV
BLACKLIST += CONFIG_VIDEO_HEXIUM_GEMINI
BLACKLIST += CONFIG_VIDEO_HEXIUM_ORION
BLACKLIST += CONFIG_VIDEO_IVTV
BLACKLIST += CONFIG_VIDEO_IVTV_ALSA
BLACKLIST += CONFIG_VIDEO_IVTV_DEPRECATED_IOCTLS
BLACKLIST += CONFIG_VIDEO_SAA7134
BLACKLIST += CONFIG_VIDEO_SAA7134_RC
BLACKLIST += CONFIG_VIDEO_SAA7134_GO7007
BLACKLIST += CONFIG_VIDEO_SAA7134_DVB
BLACKLIST += CONFIG_VIDEO_SAA7134_ALSA
BLACKLIST += CONFIG_VIDEO_SAA7164
BLACKLIST += CONFIG_VIDEO_TW5864
BLACKLIST += CONFIG_VIDEO_TW68
BLACKLIST += CONFIG_VIDEO_TW686X
BLACKLIST += CONFIG_VIDEO_CX25821_ALSA
BLACKLIST += CONFIG_VIDEO_CX25821
BLACKLIST += CONFIG_VIDEO_CX18_ALSA
BLACKLIST += CONFIG_VIDEO_CX18

# Blacklist modules that does not compile
BLACKLIST += CONFIG_VIDEO_IVTV
BLACKLIST += CONFIG_VIDEOBUF_DMA_SG
BLACKLIST += CONFIG_VIDEOBUF2_MEMOPS

include ../../mk/spksrc.cross-cc.mk

# Unsupported kernels
ifeq ($(findstring $(TC_KERNEL),$(UNSUPPORTED_KERNEL)),$(TC_KERNEL))
  ifneq (,$(BUILD_UNSUPPORTED_FILE))
    $(shell echo $(date --date=now +"%Y.%m.%d %H:%M:%S") - $(NAME): Kernel version '$(TC_KERNEL)' is not supported >> $(BUILD_UNSUPPORTED_FILE))
  endif
  @$(error Kernel version '$(TC_KERNEL)' is not supported)
endif

# Modules that does not compile under kernel 4.15
ifeq ($(findstring $(TC_KERNEL),4.4.15+),$(TC_KERNEL))
BLACKLIST += CONFIG_VIDEOBUF2_V4L2
endif

.PHONY: linuxtv_configure
linuxtv_configure:
	@$(MSG) "TC_KERNEL=$(TC_KERNEL)"
	@$(MSG) "BLACKLIST=$(BLACKLIST)"
	$(RUN) make release DIR=$(WORK_DIR)/../../../kernel/syno-$(ARCH)-$(TCVERSION)/work/source/linux
	$(RUN) make -C linux/ download
	$(RUN) make -C linux/ untar
	$(RUN) wget $(FIRMWARE_URL)/$(FIRMWARE_PKG) -O $(FIRMWARE_PKG)
	$(RUN) tar xvfj $(FIRMWARE_PKG) -C v4l
	# Final preparation for build
	$(RUN) make allyesconfig
	# Disable modules that do not compile
	$(RUN) $(foreach kmodule,$(BLACKLIST),sed -i 's/$(kmodule)=m/# $(kmodule) is not set/' v4l/.config ;)

.PHONY: linuxtv_compile
linuxtv_compile:
	$(RUN) make -j`nproc` MAKEFLAGS=
	# Disable depmod call for later install
	$(RUN) sed -i '/depmod/s/^/#/' v4l/Makefile.media

.PHONY: linuxtv_install
linuxtv_install:
	$(RUN) make install DESTDIR=$(INSTALL_DIR)/$(INSTALL_PREFIX)
	# Install firmwares
	$(RUN) tar xvfj $(FIRMWARE_PKG) -C $(INSTALL_DIR)/$(INSTALL_PREFIX)/lib
	# Dynamically create PLIST for driver modules & firmwares
	$(RUN) find $(INSTALL_DIR)/$(INSTALL_PREFIX) -type f -name *.ko | sed -e 's,.*\(module\),\1,g' -e 's,^,lib:lib/,'    > ../PLIST
	$(RUN) find $(INSTALL_DIR)/$(INSTALL_PREFIX) -type f -name *.fw | sed -e 's,.*\(firmware\),\1,g' -e 's,^,bin:lib/,' >> ../PLIST
