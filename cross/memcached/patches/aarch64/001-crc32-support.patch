From 0548859b47a90fcbe5da97ed2a71e2660384cc48 Mon Sep 17 00:00:00 2001
From: Sergey Dryabzhinsky <sergey@rusoft.ru>
Date: Tue, 24 Nov 2020 22:16:56 +0300
Subject: [PATCH] For issue #743 - Fix missing hw crc32 capability check on
 arm64 for old gcc/libc

---
 crc32c.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/crc32c.c b/crc32c.c
index 916e0e67e..d2e359826 100644
--- crc32c.c
+++ crc32c.c
@@ -275,7 +275,7 @@ void crc32c_init(void) {

 #elif defined(__aarch64__) && defined(__linux__)
 #include <sys/auxv.h>
-
+#if defined(HWCAP_CRC32)
 static inline uint32_t crc32cx(uint32_t crc, const uint64_t data)
 {
         asm(".arch_extension crc\n"
@@ -336,6 +336,12 @@ void crc32c_init(void) {
     if (auxv & HWCAP_CRC32)
         crc32c = crc32c_hw;
 }
+#else /* no hw crc32 on arm64 system supported? old compiler/libc/kernel? */
+void crc32c_init(void) {
+    crc32c = crc32c_sw;
+}
+#endif
+
 #else /* !__x86_64__i && !__aarch64__ */
 void crc32c_init(void) {
     crc32c = crc32c_sw;