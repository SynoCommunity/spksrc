From 5ffcbe81466e8afbe5549741b58f410311749fdf Mon Sep 17 00:00:00 2001
From: Ross Brown <rbrownwsws@googlemail.com>
Date: Sat, 17 Apr 2021 14:35:39 +0000
Subject: [PATCH] Fix apparmor profile prefixes

---
 config/apparmor/abstractions/start-container.in      | 12 ++++++------
 .../{usr.bin.lxc-start => usr.bin.lxc-start.in}      |  2 +-
 configure.ac                                         |  1 +
 3 files changed, 8 insertions(+), 7 deletions(-)
 rename config/apparmor/{usr.bin.lxc-start => usr.bin.lxc-start.in} (58%)

diff --git config/apparmor/abstractions/start-container.in config/apparmor/abstractions/start-container.in
index 9f64c27..9d35418 100644
--- config/apparmor/abstractions/start-container.in
+++ config/apparmor/abstractions/start-container.in
@@ -9,8 +9,8 @@
   ptrace,
 
   # currently blocked by apparmor bug
-  mount -> /usr/lib*/*/lxc/{**,},
-  mount -> /usr/lib*/lxc/{**,},
+  mount -> @PREFIX@/lib*/*/lxc/{**,},
+  mount -> @PREFIX@/lib*/lxc/{**,},
   mount -> @LXCROOTFSMOUNT@/{,**},
   mount fstype=devpts -> /dev/pts/,
   mount options=bind /dev/pts/ptmx/ -> /dev/ptmx/,
@@ -38,10 +38,10 @@
   # This may look a bit redundant, however it appears we need all of
   # them if we want things to work properly on all combinations of kernel
   # and userspace parser...
-  pivot_root /usr/lib*/lxc/,
-  pivot_root /usr/lib*/*/lxc/,
-  pivot_root /usr/lib*/lxc/**,
-  pivot_root /usr/lib*/*/lxc/**,
+  pivot_root @PREFIX@/lib*/lxc/,
+  pivot_root @PREFIX@/lib*/*/lxc/,
+  pivot_root @PREFIX@/lib*/lxc/**,
+  pivot_root @PREFIX@/lib*/*/lxc/**,
   pivot_root @LXCROOTFSMOUNT@/{,**},
 
   change_profile -> lxc-*,
diff --git config/apparmor/usr.bin.lxc-start config/apparmor/usr.bin.lxc-start.in
similarity index 58%
rename from config/apparmor/usr.bin.lxc-start
rename to config/apparmor/usr.bin.lxc-start.in
index 2f87cdd..c5ed803 100644
--- config/apparmor/usr.bin.lxc-start
+++ config/apparmor/usr.bin.lxc-start.in
@@ -1,5 +1,5 @@
 #include <tunables/global>
 
-/usr/bin/lxc-start flags=(attach_disconnected) {
+@PREFIX@/bin/lxc-start flags=(attach_disconnected) {
   #include <abstractions/lxc/start-container>
 }
diff --git configure.ac configure.ac
index d32fecc..149f5fe 100644
--- configure.ac
+++ configure.ac
@@ -830,6 +830,7 @@ AC_CONFIG_FILES([
 
 	config/Makefile
 	config/apparmor/Makefile
+	config/apparmor/usr.bin.lxc-start
 	config/apparmor/abstractions/start-container
 	config/selinux/Makefile
 	config/bash/Makefile
-- 
2.25.1

