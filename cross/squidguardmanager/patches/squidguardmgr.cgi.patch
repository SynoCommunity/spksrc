--- cgi-bin/squidguardmgr.cgi.orig	2015-04-11 12:27:37.478461786 +0200
+++ cgi-bin/squidguardmgr.cgi	2015-04-10 22:45:29.000000000 +0200
@@ -14,6 +14,62 @@
 
 use strict qw{vars subs};
 
+my $user;
+my $admin=0;
+if (open (IN,"/usr/syno/synoman/webman/modules/authenticate.cgi|")) {
+	$user=<IN>;
+	chop($user);
+	close(IN);
+}
+open GROUP, "</etc/group"
+   or die "Could not find /etc/group: $!\n";
+while (<GROUP>) {
+  my ($group,$x,$gid,$list)=split(':',$_);
+  chop($list);
+  if ($group eq "administrators") {
+	my (@users)=split(',',$list);
+	$admin = 1 if (grep {$_ eq $user} @users);
+  }
+}
+
+if ( `synoldapclient --get-user $user | grep " administrators@"` ){
+        $admin = 1;
+}
+
+# if not admin or no user at all...no authentication...so, bye-bye
+if ($admin == 0) {
+	print "Content-type: text/html\n\n";
+	print "<HTML><HEAD><TITLE>Login Required</TITLE></HEAD><BODY>Please login as admin first, before using this webpage</BODY></HTML>\n";
+	die;
+}
+
+our $LANG       = 'en_US';
+#
+# RETURN THE FIRST SUPPORTED LANGUAGE OF THE BROWSERS PREFERRED OR THE
+# DEFAULT:
+#
+sub getpreferedlang(@) {
+  my @supported = @_;
+  my @languages = split(/\s*,\s*/,$ENV{"HTTP_ACCEPT_LANGUAGE"}) if(defined($ENV{"HTTP_ACCEPT_LANGUAGE"}));
+  my $lang;
+  my $supp;
+  push(@languages,$supported[0]);
+  for $lang (@languages) {
+    $lang =~ s/-/_/;
+    if ($lang =~ /[a-z]{2}_[A-Z]{2}/ ) {
+    	for $supp (@supported) {
+      		$supp =~ s/\s.*//;
+      		return($lang) if ($lang eq $supp);
+      	}
+    }
+  }
+}
+our @supported   = (
+		"en_US",
+		"fr_FR"
+		);
+$LANG = getpreferedlang(@supported);
+
 $VERSION     = '1.14',
 $AUTHOR      = 'Gilles DAROLD <gilles AT darold DOT net>';
 $COPYRIGHT   = 'Copyright &copy; 2010-2015 Gilles DAROLD, all rights reserved';
@@ -24,8 +80,8 @@
 my $SC_PROGRAM  = 'SquidClamav Manager';
 
 # Default SquidGuard installation path
-my $DBHOME = "/var/lib/squidguard/db";
-my $LOGDIR = "/var/log/squidguard";
+my $DBHOME = "/usr/local/squidguard/var/db";
+my $LOGDIR = "/usr/local/squidguard/var/logs";
 
 # Variables that can be overidden into the squidguardmgr.conf file
 our $DIFF       = '/usr/bin/diff';
@@ -37,7 +93,6 @@
 our $BLDESC     = 'description.dat';
 our $CONF_FILE  = '/usr/local/squidGuard/squidguard.conf';
 our $LANGDIR    = 'lang';
-our $LANG       = 'en_US';
 our $IMG_DIR    = 'images';
 our $CSS_FILE   = 'squidguardmgr.css';
 our $JS_FILE    = 'squidguardmgr.js';
@@ -48,7 +103,7 @@
 our $SQUID_WRAPPER = '/var/www/squidguardmgr/squid_wrapper';
 our $C_ICAP_SOCKET = '/var/run/c-icap/c-icap.ctl';
 our $KEEP_DIFF  = 1;
-our $BLUMASK    = 0027;
+our $BLUMASK    = 0022;
 
 # Configuration file
 my $SGM_CONF    = 'squidguardmgr.conf';
@@ -161,7 +216,7 @@
 	if ($VIEW eq 'squid') {
 		if ($SQUID_WRAPPER) {
 			print "Running: $SQUID_WRAPPER ... \n";
-			$ERROR = `$SQUID_WRAPPER 2>&1`;
+			$ERROR = `su squid -c "$SQUID_WRAPPER 2>&1"`;
 			&error($ERROR) if ($ERROR);
 			print "Ok." if (!$ERROR);
 		}
@@ -276,7 +331,7 @@
 
 if ($ACTION eq 'squid') {
 	if ($SQUID_WRAPPER) {
-		$ERROR = `$SQUID_WRAPPER`;
+		$ERROR = `su squid -c "$SQUID_WRAPPER 2>&1"`;
 	}
 	$ACTION = '';
 }
@@ -924,14 +979,14 @@
 	}
 	if (-e "$file.db") {
 		# Now load these items dynamically into squidGuard
-		if (open(OUT, ">$file.tmpdiff")) {
+		if (open(OUT, ">$file.diff")) {
 			map { s/^/\+/; } @add;
 			print OUT join("\n", @add), "\n";
 			close OUT;
-			print `$SQUIDGUARD -u $file.tmpdiff`;
-			unlink("$file.tmpdiff");
+			$ERROR = `su squid -c "$SQUIDGUARD -u"`;
+			unlink("$file.diff");
 		} else {
-			&error("Can't open $file.tmpdiff for writing: $!<br>");
+			&error("Can't open $file.diff for writing: $!<br>");
 		}
 	} else {
 		$file =~ s#$CONFIG->{dbhome}/##;
@@ -989,14 +1044,14 @@
 		}
 		if (-e "$file.db") {
 			# Now load these items dynamically into squidGuard
-			if (open(OUT, ">$file.tmpdiff")) {
+			if (open(OUT, ">$file.diff")) {
 				map { s/^/\-/; } @removed;
 				print OUT join("\n", @removed), "\n";
 				close OUT;
-				print `$SQUIDGUARD -u $file.tmpdiff`;
-				unlink("$file.tmpdiff");
+				$ERROR = `su squid -c "$SQUIDGUARD -u"`;
+				unlink("$file.diff");
 			} else {
-				&error("Can't open $file.tmpdiff for writing: $!");
+				&error("Can't open $file.diff for writing: $!");
 			}
 		} else {
 			$file =~ s#$CONFIG->{dbhome}/##;
@@ -2633,11 +2688,11 @@
 	if (-e "$CONFIG->{dbhome}/$bl") {
 		# Create a diff file
 		if ($DIFF) {
-			`$DIFF -U 0 $CONFIG->{dbhome}/$bl $CONFIG->{dbhome}/$bl.tmp  | $GREP -v "^\@\@" | $GREP -v "^--- " | $GREP -v "^+++ " > $CONFIG->{dbhome}/$bl.tmpdiff`;
-			print `$SQUIDGUARD -u $CONFIG->{dbhome}/$bl.tmpdiff`;
+			`su squid -c "$DIFF -U 0 $CONFIG->{dbhome}/$bl $CONFIG->{dbhome}/$bl.tmp  | $GREP -v '^\@\@' | $GREP -v '^--- ' | $GREP -v '^+++ ' > $CONFIG->{dbhome}/$bl.diff"`;
+			$ERROR = `su squid -c "$SQUIDGUARD -u"`;
 			# Save diff into the historical file.
 			if ($KEEP_DIFF) {
-				if (open(IN, "$CONFIG->{dbhome}/$bl.tmpdiff")) {
+				if (open(IN, "$CONFIG->{dbhome}/$bl.diff")) {
 					my @text = <IN>;
 					close(IN);
 					if (open(OUT, ">>$CONFIG->{dbhome}/$bl.diff.hist")) {
@@ -2647,10 +2702,10 @@
 						&error("Can't write to file $CONFIG->{dbhome}/$bl.diff.hist: $!");
 					}
 				} else {
-					&error("Can't read file $CONFIG->{dbhome}/$bl.tmpdiff: $!");
+					&error("Can't read file $CONFIG->{dbhome}/$bl.diff: $!");
 				}
 			}
-			unlink("$CONFIG->{dbhome}/$bl.tmpdiff");
+			unlink("$CONFIG->{dbhome}/$bl.diff");
 		}
 		unlink("$CONFIG->{dbhome}/$bl");
 		$delbl = 1 if ($nline == 0);
@@ -3586,9 +3641,9 @@
 	my $bl = shift;
 
 	if ($bl eq 'all') {
-		$ERROR = `$SQUIDGUARD -C all`;
+		$ERROR = `su squid -c "$SQUIDGUARD -C all"`;
 	} else {
-		$ERROR = `$SQUIDGUARD -C $bl`;
+		$ERROR = `su squid -c "$SQUIDGUARD -C $bl"`;
 	}
 }
 
