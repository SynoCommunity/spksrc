#!/bin/sh

# Package
PACKAGE="ps3netsrv"
DNAME="ps3netsrv"
USER="ps3netsrv"

# Others
[ ${SYNOPKG_PKGDEST} ] || SYNOPKG_PKGDEST=`ls -l /var/packages/ps3netsrv/target | cut -d\> -f2 | cut -d\  -f2`


start_daemon ()
{
    sudo -u ${USER} /bin/sh -c "${SYNOPKG_PKGDEST}/bin/${DNAME} @PS3_dir@ @PS3_port@ &"
}

stop_daemon ()
{
	kill `pidof ${DNAME}`
	wait_for_status 1 20 || kill -9 `pidof ${DNAME}`
}

daemon_status ()
{
	status=`ps aux | grep "[p]s3netsrv" | awk -vpid=$$ '$2 != pid { print $1 }'`
	if [ ! -z "$status" ] && kill -0 `pidof ${DNAME}` > /dev/null 2>&1; then
		return
	fi
	return 1
}

wait_for_status ()
{
	counter=$2
	while [ ${counter} -gt 0 ]; do
		daemon_status
		[ $? -eq $1 ] && return
		let counter=counter-1
		sleep 1
	done
	return 1
}

case $1 in
	start)
		if daemon_status; then
			echo ${PACKAGE} is already running
			exit 0
		else
			echo Starting ${PACKAGE} ...
			start_daemon
			exit $?
		fi
		;;
	stop)
		if daemon_status; then
			echo Stopping ${PACKAGE} ...
			stop_daemon
			exit $?
		else
			echo ${PACKAGE} is not running
			exit 0
		fi
		;;
	restart)
		echo Restarting ${PACKAGE} ...
		stop_daemon
		start_daemon
		exit $?
		;;
	status)
		if daemon_status; then
			echo ${PACKAGE} is running
			exit 0
		else
			echo ${PACKAGE} is not running
			exit 1
		fi
		;;
	help)
		echo "usage: $0 (start|stop|restart|status|debug|rescan|log|help)"
		/bin/cat <<EOF

start      - start $PACKAGE
stop       - stop $PACKAGE
restart    - stop and restart $PACKAGE if running or start if not running
status     - tell whether $PACKAGE is running or not
help       - this text

EOF
		;;
	*)
		$0 help
		;;
esac
exit 0
